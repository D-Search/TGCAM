# install_compatible_pytorch.py
import subprocess
import sys
import torch

def install_compatible_pytorch():
    """å®‰è£…å…¼å®¹Tesla P40çš„PyTorchç‰ˆæœ¬"""
    
    print("ğŸ”§ å®‰è£…å…¼å®¹Tesla P40çš„PyTorchç‰ˆæœ¬...")
    
    # Tesla P40è®¡ç®—èƒ½åŠ›: 6.1
    # éœ€è¦å®‰è£…æ”¯æŒè®¡ç®—èƒ½åŠ›6.1çš„ç‰ˆæœ¬
    
    # å¸è½½å½“å‰ç‰ˆæœ¬
    print("1. å¸è½½å½“å‰PyTorch...")
    subprocess.run([sys.executable, "-m", "pip", "uninstall", "torch", "torchvision", "torchaudio", "-y"])
    
    # å®‰è£…å…¼å®¹ç‰ˆæœ¬
    print("2. å®‰è£…å…¼å®¹ç‰ˆæœ¬...")
    
    # å°è¯•ä¸åŒçš„ç‰ˆæœ¬ç»„åˆ
    version_combinations = [
        # PyTorch 1.13 + CUDA 11.7 (å¯¹P40å…¼å®¹æ€§å¥½)
        ("torch==1.13.1+cu117", "torchvision==0.14.1+cu117", "torchaudio==0.13.1+cu117"),
        # PyTorch 2.0 + CUDA 11.8
        ("torch==2.0.1+cu118", "torchvision==0.15.2+cu118", "torchaudio==2.0.2+cu118"),
        # PyTorch 2.1 + CUDA 11.8
        ("torch==2.1.2+cu118", "torchvision==0.16.2+cu118", "torchaudio==2.1.2+cu118"),
    ]
    
    for torch_ver, torchvision_ver, torchaudio_ver in version_combinations:
        print(f"\nğŸ”„ å°è¯•å®‰è£…: {torch_ver}")
        
        commands = [
            f"pip install {torch_ver} --index-url https://download.pytorch.org/whl/cu117",
            f"pip install {torchvision_ver} --index-url https://download.pytorch.org/whl/cu117", 
            f"pip install {torchaudio_ver} --index-url https://download.pytorch.org/whl/cu117"
        ]
        
        success = True
        for cmd in commands:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
            if result.returncode != 0:
                print(f"âŒ å®‰è£…å¤±è´¥: {result.stderr}")
                success = False
                break
        
        if success:
            print("âœ… å®‰è£…æˆåŠŸ!")
            return True
    
    return False

def test_p40_compatibility():
    """æµ‹è¯•Tesla P40å…¼å®¹æ€§"""
    print("\nğŸ§ª æµ‹è¯•Tesla P40å…¼å®¹æ€§...")
    
    try:
        import torch
        print(f"PyTorchç‰ˆæœ¬: {torch.__version__}")
        print(f"CUDAå¯ç”¨: {torch.cuda.is_available()}")
        
        if torch.cuda.is_available():
            # è®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶ä½¿ç”¨è€çš„è®¡ç®—èƒ½åŠ›
            import os
            os.environ['CUDA_LAUNCH_BLOCKING'] = '1'
            
            # æµ‹è¯•ç®€å•è®¡ç®—
            device = torch.device('cuda:0')
            x = torch.randn(100, 100, device=device)
            y = torch.randn(100, 100, device=device)
            z = x + y
            
            print("âœ… åŸºç¡€è®¡ç®—æµ‹è¯•é€šè¿‡")
            
            # æµ‹è¯•çŸ©é˜µä¹˜æ³•
            try:
                result = torch.matmul(x, y)
                print("âœ… çŸ©é˜µä¹˜æ³•æµ‹è¯•é€šè¿‡")
            except Exception as e:
                print(f"âš ï¸  çŸ©é˜µä¹˜æ³•å¤±è´¥: {e}")
                
            return True
        else:
            print("âŒ CUDAä¸å¯ç”¨")
            return False
            
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    if install_compatible_pytorch():
        if test_p40_compatibility():
            print("\nğŸ‰ Tesla P40å…¼å®¹æ€§é—®é¢˜å·²è§£å†³!")
        else:
            print("\nâŒ å…¼å®¹æ€§é—®é¢˜ä»ç„¶å­˜åœ¨")
    else:
        print("\nâŒ å®‰è£…å¤±è´¥")
